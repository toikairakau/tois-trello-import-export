<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background: #f4f5f7; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    h1 { color: #172b4d; margin: 0 0 10px 0; }
    .subtitle { color: #5e6c84; margin-bottom: 30px; }
    .section { background: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #0079bf; }
    .section h2 { margin-top: 0; color: #172b4d; font-size: 18px; }
    .button { background: #0079bf; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px 5px 5px 0; display: inline-flex; align-items: center; gap: 8px; }
    .button:hover { background: #026aa7; }
    .button:disabled { background: #ccc; cursor: not-allowed; }
    .file-input { display: none; }
    .upload-area { border: 2px dashed #0079bf; border-radius: 5px; padding: 30px; text-align: center; margin: 15px 0; background: white; cursor: pointer; transition: all 0.3s; }
    .upload-area:hover { background: #f0f8ff; border-color: #026aa7; }
    .upload-area.dragover { background: #e3f2fd; border-color: #026aa7; }
    .status { padding: 15px; border-radius: 5px; margin-top: 15px; display: none; }
    .status.success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
    .status.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; }
    .status.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }
    .loading { display: none; text-align: center; padding: 20px; color: #5e6c84; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0079bf; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .info-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 3px; }
    .list-selector { margin: 15px 0; }
    .list-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px; margin: 5px 0; background: white; border-radius: 3px; cursor: pointer; }
    .list-checkbox:hover { background: #f0f0f0; }
    .select-all { font-weight: bold; background: #e3f2fd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Import/Export Cards</h1>
    <p class="subtitle">Bulk import and export your Trello cards to Excel or CSV</p>
    <div class="section">
      <h2>üì• Export Cards</h2>
      <p>Download all cards from this board as Excel or CSV</p>
      <div class="list-selector" id="exportListSelector">
        <label class="list-checkbox select-all">
          <input type="checkbox" id="selectAllExport" checked>
          <span><strong>Select All Lists</strong></span>
        </label>
        <div id="exportLists"></div>
      </div>
      <button class="button" onclick="exportToExcel()">üìä Export to Excel (.xlsx)</button>
      <button class="button" onclick="exportToCSV()">üìÑ Export to CSV</button>
    </div>
    <div class="section">
      <h2>üì§ Import Cards</h2>
      <p>Upload an Excel or CSV file to create cards in bulk</p>
      <div class="info-box">
        <strong>Required columns:</strong> name, list<br>
        <strong>Optional columns:</strong> desc, due, labels, members
      </div>
      <div class="list-selector" id="importListSelector" style="display:none;">
        <p><strong>Target List:</strong></p>
        <div id="importLists"></div>
      </div>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
        <div style="font-size: 16px; color: #172b4d; margin-bottom: 5px;">
          <strong>Click to upload or drag & drop</strong>
        </div>
        <div style="font-size: 14px; color: #5e6c84;">Supports Excel (.xlsx) and CSV files</div>
      </div>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
      <button class="button" id="importButton" onclick="importCards()" disabled>‚¨ÜÔ∏è Import Cards</button>
    </div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Processing...</div>
    </div>
    <div class="status" id="status"></div>
  </div>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    var t = window.TrelloPowerUp.iframe();
    var boardData = {};
    var uploadedData = null;
    var uploadedFile = null;
    async function initialize() {
      try {
        var board = await t.board('id', 'name', 'lists', 'members', 'labels');
        boardData = board;
        renderExportListSelector();
        renderImportListSelector();
      } catch (error) {
        showStatus('Error loading board data: ' + error.message, 'error');
      }
    }
    function renderExportListSelector() {
      var container = document.getElementById('exportLists');
      container.innerHTML = '';
      boardData.lists.forEach(function(list) {
        var label = document.createElement('label');
        label.className = 'list-checkbox';
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = list.id;
        checkbox.checked = true;
        checkbox.className = 'export-list-checkbox';
        var span = document.createElement('span');
        span.textContent = list.name;
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
      document.getElementById('selectAllExport').addEventListener('change', function(e) {
        document.querySelectorAll('.export-list-checkbox').forEach(function(cb) {
          cb.checked = e.target.checked;
        });
      });
    }
    function renderImportListSelector() {
      var container = document.getElementById('importLists');
      container.innerHTML = '';
      boardData.lists.forEach(function(list) {
        var label = document.createElement('label');
        label.className = 'list-checkbox';
        var radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'importList';
        radio.value = list.id;
        var span = document.createElement('span');
        span.textContent = list.name;
        label.appendChild(radio);
        label.appendChild(span);
        container.appendChild(label);
      });
    }
    async function exportToExcel() {
      showLoading(true);
      try {
        var selectedListIds = getSelectedExportLists();
        if (selectedListIds.length === 0) {
          showStatus('Please select at least one list to export', 'error');
          showLoading(false);
          return;
        }
        var cards = await t.cards('all');
        var filteredCards = cards.filter(function(card) {
          return selectedListIds.includes(card.idList);
        });
        var data = filteredCards.map(function(card) {
          var list = boardData.lists.find(function(l) { return l.id === card.idList; });
          return {
            'Card Name': card.name,
            'List': list ? list.name : '',
            'Description': card.desc || '',
            'Due Date': card.due ? new Date(card.due).toLocaleDateString() : '',
            'Labels': card.labels ? card.labels.map(function(l) { return l.name; }).join(', ') : '',
            'Members': card.idMembers ? card.idMembers.length : 0,
            'URL': card.url
          };
        });
        var ws = XLSX.utils.json_to_sheet(data);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Cards');
        XLSX.writeFile(wb, boardData.name + '_cards_export.xlsx');
        showStatus('Successfully exported ' + filteredCards.length + ' cards to Excel!', 'success');
      } catch (error) {
        showStatus('Error exporting: ' + error.message, 'error');
      }
      showLoading(false);
    }
    async function exportToCSV() {
      showLoading(true);
      try {
        var selectedListIds = getSelectedExportLists();
        if (selectedListIds.length === 0) {
          showStatus('Please select at least one list to export', 'error');
          showLoading(false);
          return;
        }
        var cards = await t.cards('all');
        var filteredCards = cards.filter(function(card) {
          return selectedListIds.includes(card.idList);
        });
        var data = filteredCards.map(function(card) {
          var list = boardData.lists.find(function(l) { return l.id === card.idList; });
          return {
            'Card Name': card.name,
            'List': list ? list.name : '',
            'Description': card.desc || '',
            'Due Date': card.due ? new Date(card.due).toLocaleDateString() : '',
            'Labels': card.labels ? card.labels.map(function(l) { return l.name; }).join(', ') : '',
            'Members': card.idMembers ? card.idMembers.length : 0,
            'URL': card.url
          };
        });
        var csv = Papa.unparse(data);
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = boardData.name + '_cards_export.csv';
        link.click();
        showStatus('Successfully exported ' + filteredCards.length + ' cards to CSV!', 'success');
      } catch (error) {
        showStatus('Error exporting: ' + error.message, 'error');
      }
      showLoading(false);
    }
    function getSelectedExportLists() {
      var selected = [];
      document.querySelectorAll('.export-list-checkbox:checked').forEach(function(cb) {
        selected.push(cb.value);
      });
      return selected;
    }
    var uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', function() {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      var files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    function handleFileSelect(event) {
      var file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }
    function handleFile(file) {
      uploadedFile = file;
      var fileName = file.name;
      var fileExt = fileName.split('.').pop().toLowerCase();
      if (fileExt === 'csv') {
        Papa.parse(file, {
          header: true,
          complete: function(results) {
            uploadedData = results.data;
            showStatus('File loaded: ' + fileName + ' (' + uploadedData.length + ' rows)', 'success');
            document.getElementById('importButton').disabled = false;
            document.getElementById('importListSelector').style.display = 'block';
          },
          error: function(error) {
            showStatus('Error reading CSV: ' + error.message, 'error');
          }
        });
      } else if (fileExt === 'xlsx' || fileExt === 'xls') {
        var reader = new FileReader();
        reader.onload = function(e) {
          var data = new Uint8Array(e.target.result);
          var workbook = XLSX.read(data, { type: 'array' });
          var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          uploadedData = XLSX.utils.sheet_to_json(firstSheet);
          showStatus('File loaded: ' + fileName + ' (' + uploadedData.length + ' rows)', 'success');
          document.getElementById('importButton').disabled = false;
          document.getElementById('importListSelector').style.display = 'block';
        };
        reader.readAsArrayBuffer(file);
      } else {
        showStatus('Unsupported file type. Please use .xlsx or .csv', 'error');
      }
    }
    async function importCards() {
      if (!uploadedData || uploadedData.length === 0) {
        showStatus('No data to import', 'error');
        return;
      }
      var selectedList = document.querySelector('input[name="importList"]:checked');
      if (!selectedList) {
        showStatus('Please select a target list', 'error');
        return;
      }
      showLoading(true);
      var successCount = 0;
      var errorCount = 0;
      for (var i = 0; i < uploadedData.length; i++) {
        var row = uploadedData[i];
        if (!row['Card Name'] && !row['name']) {
          errorCount++;
          continue;
        }
        try {
          var cardData = {
            name: row['Card Name'] || row['name'],
            desc: row['Description'] || row['desc'] || '',
            idList: selectedList.value
          };
          if (row['Due Date'] || row['due']) {
            var dueDate = new Date(row['Due Date'] || row['due']);
            if (!isNaN(dueDate.getTime())) {
              cardData.due = dueDate.toISOString();
            }
          }
          await t.card('create', cardData);
          successCount++;
        } catch (error) {
          console.error('Error creating card:', error);
          errorCount++;
        }
      }
      showLoading(false);
      showStatus('Import complete! Created ' + successCount + ' cards. ' + (errorCount > 0 ? errorCount + ' errors.' : ''), 'success');
      document.getElementById('importButton').disabled = true;
      uploadedData = null;
    }
    function showStatus(message, type) {
      var status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
      setTimeout(function() {
        status.style.display = 'none';
      }, 5000);
    }
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    initialize();
  </script>
</body>
</html>